name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Install Playwright dependencies
        run: npx playwright install --with-deps

      # Electron's bundled Chromium needs system libs that `playwright install --with-deps`
      # doesn't cover (it only installs deps for Playwright's own browsers).
      # On Ubuntu 24.04, libasound2 was renamed to libasound2t64 (64-bit time_t transition).
      - name: Install Electron system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
            libgtk-3-0 libgbm1 libxcomposite1 libxdamage1 libxfixes3 \
            libxrandr2 libxkbcommon0 libpango-1.0-0 libcairo2 libdbus-1-3 \
            libatspi2.0-0
          sudo apt-get install -y libasound2t64 || sudo apt-get install -y libasound2

      # Ubuntu 24.04 (ubuntu-latest) restricts unprivileged user namespaces via AppArmor,
      # which prevents Electron/Chromium from creating sandboxed child processes.
      # This causes "Process failed to launch!" errors. See:
      #   - electron/electron#41066
      #   - microsoft/playwright#34238
      - name: Disable AppArmor unprivileged userns restriction
        run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Run e2e tests
        run: xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" npm run test:e2e
